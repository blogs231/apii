<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <!-- SEO -->
  <meta name="author" content="HLS Video Player" />
  <meta name="description" content="Watch Live Streaming with HLS support. Use ?url=YOUR_STREAM_URL" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

  <title>HLS Video Player</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">

  <!-- HLS.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      padding: 0;
      margin: 0;
      overflow: hidden;
      background: #000;
      font-family: Arial, sans-serif;
    }

    body.hideOverlays * {
      cursor: none !important;
    }

    body.hideOverlays #controls, 
    body.hideOverlays #metadata,
    body.hideOverlays .loading-overlay,
    body.hideOverlays .stream-info {
      opacity: 0;
      pointer-events: none;
    }

    .player-container {
      position: relative;
      width: 100%;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }

    video {
      width: 100%;
      height: 100%;
      min-height: 200px;
      min-width: 350px;
      object-fit: contain;
      cursor: pointer;
    }

    /* Metadata overlay */
    #metadata {
      position: absolute;
      top: 0;
      left: 0;
      color: white;
      padding: 1em;
      background: rgba(0, 0, 0, 0.7);
      box-sizing: border-box;
      backdrop-filter: blur(5px);
      transition: opacity 0.3s ease;
      z-index: 100;
    }

    #title {
      font-weight: bold;
      font-size: 1.5em;
      margin-bottom: 5px;
    }

    #subtitle {
      font-size: 0.9em;
      opacity: 0.8;
    }

    /* Controls overlay */
    #controls {
      font-family: 'Font Awesome 6 Free', Arial, sans-serif;
      color: white;
      font-size: 14px;
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      box-sizing: border-box;
      padding: 10px 20px;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
      transition: opacity 0.3s ease;
      z-index: 100;
    }

    #play_pause {
      padding: 0 15px;
      display: flex;
      align-items: center;
    }

    #play, #pause {
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 18px;
      transition: color 0.2s ease;
    }

    #play:hover, #pause:hover {
      color: #1e90ff;
    }

    .speaker {
      padding: 0 10px;
      display: flex;
      align-items: center;
    }

    #muted, #unmuted {
      width: 18px;
      height: 18px;
      cursor: pointer;
      font-size: 16px;
      transition: color 0.2s ease;
    }

    #muted:hover, #unmuted:hover {
      color: #1e90ff;
    }

    #volume {
      width: 80px;
      margin-left: 10px;
      cursor: pointer;
    }

    #volume:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .time {
      font-family: 'Inconsolata', monospace;
      font-size: 13px;
      display: flex;
      align-items: center;
    }

    #elapsed {
      padding-left: 15px;
    }

    #separator {
      padding: 0 5px;
      opacity: 0.7;
    }

    #duration {
      padding-right: 15px;
    }

    .seek {
      flex-grow: 1;
      display: flex;
      align-items: center;
      padding: 0 15px;
    }

    #seek {
      width: 100%;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
    }

    #seek::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      background: #1e90ff;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    #seek::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    #seek::-moz-range-thumb {
      width: 14px;
      height: 14px;
      background: #1e90ff;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    input[type='range'] {
      display: block;
      width: 100%;
    }

    /* Loading overlay */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      z-index: 1000;
      transition: opacity 0.3s ease;
    }

    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #1e90ff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      text-align: center;
    }

    /* Error overlay */
    .error-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #ff6b6b;
      z-index: 1001;
      padding: 20px;
      text-align: center;
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .error-title {
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .error-message {
      font-size: 14px;
      margin-bottom: 20px;
      opacity: 0.8;
      max-width: 400px;
    }

    .retry-btn {
      padding: 12px 24px;
      background: #1e90ff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: background 0.3s ease;
    }

    .retry-btn:hover {
      background: #4169e1;
    }

    /* Stream info */
    .stream-info {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 100;
      backdrop-filter: blur(5px);
      transition: opacity 0.3s ease;
    }

    .hidden {
      display: none !important;
    }

    /* Responsive design */
    @media (max-width: 500px) {
      #separator, #duration {
        display: none;
      }
      
      #elapsed {
        padding-right: 10px;
      }
      
      #controls {
        padding: 10px 15px;
        height: 50px;
      }
      
      .stream-info {
        top: 10px;
        right: 10px;
        font-size: 11px;
        padding: 6px 10px;
      }
      
      #metadata {
        padding: 0.8em;
      }
      
      #title {
        font-size: 1.2em;
      }
    }

    @media (max-width: 350px) {
      #volume {
        display: none;
      }
      
      .speaker {
        padding-right: 5px;
      }
    }
  </style>
</head>

<body>
  <div class="player-container">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <div class="loading-text">Loading stream...</div>
    </div>

    <!-- Error Overlay -->
    <div class="error-overlay" id="errorOverlay">
      <div class="error-icon">⚠️</div>
      <div class="error-title">Stream Error</div>
      <div class="error-message" id="errorMessage">Failed to load the stream</div>
      <button class="retry-btn" onclick="retryStream()">Retry Stream</button>
    </div>

    <!-- Video Player -->
    <video 
      id="video" 
      preload="metadata" 
      playsinline
      webkit-playsinline>
    </video>

    <!-- Stream Info -->
    <div class="stream-info" id="streamInfo">
      <span id="qualityInfo">Loading...</span>
    </div>

    <!-- Controls Overlay -->
    <div id="controls">
      <div id="play_pause">
        <i id="play" class="fas fa-play"></i>
        <i id="pause" class="fas fa-pause hidden"></i>
      </div>
      
      <div class="time">
        <span id="elapsed">00:00</span>
        <span id="separator">/</span>
        <span id="duration">00:00</span>
      </div>
      
      <div class="seek">
        <input type="range" id="seek" min="0" max="100" value="0" step="0.1">
      </div>
      
      <div class="speaker">
        <i id="unmuted" class="fas fa-volume-up"></i>
        <i id="muted" class="fas fa-volume-mute hidden"></i>
        <input type="range" id="volume" min="0" max="1" value="0.8" step="0.1">
      </div>
    </div>
  </div>

  <script>
    class HLSVideoPlayer {
      constructor() {
        this.video = document.getElementById('video');
        this.controls = document.getElementById('controls');
        this.metadata = document.getElementById('metadata');
        this.play = document.getElementById('play');
        this.pause = document.getElementById('pause');
        this.elapsed = document.getElementById('elapsed');
        this.duration = document.getElementById('duration');
        this.seek = document.getElementById('seek');
        this.muted = document.getElementById('muted');
        this.unmuted = document.getElementById('unmuted');
        this.volume = document.getElementById('volume');
        this.loadingOverlay = document.getElementById('loadingOverlay');
        this.errorOverlay = document.getElementById('errorOverlay');
        this.streamInfo = document.getElementById('streamInfo');
        
        this.hls = null;
        this.videoUrl = null;
        this.hideOverlaysTimer = null;
        this.isLive = false;
        
        this.init();
      }

      // Utility functions
      toHHMMSS(value) {
        const sec_num = parseInt(value, 10);
        const hoursInt = Math.floor(sec_num / 3600);
        let minutes = Math.floor((sec_num - (hoursInt * 3600)) / 60);
        let seconds = sec_num - (hoursInt * 3600) - (minutes * 60);
        let hours = '';

        if (hoursInt > 0) {
          hours = (hoursInt < 10 ? '0' : '') + hoursInt + ':';
        }
        if (minutes < 10) minutes = '0' + minutes;
        if (seconds < 10) seconds = '0' + seconds;
        
        return hours + minutes + ':' + seconds;
      }

      getParameterByName(name) {
        const url = window.location.href;
        const cleanName = name.replace(/[\[\]]/g, "\\$&");
        const regex = new RegExp("[?&]" + cleanName + "(=([^&#]*)|&|#|$)");
        const results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }

      videoDimensions() {
        const videoRatio = this.video.videoWidth / this.video.videoHeight;
        let width = this.video.offsetWidth;
        let height = this.video.offsetHeight;
        const elementRatio = width / height;
        
        if (elementRatio > videoRatio) {
          width = height * videoRatio;
        } else {
          height = width / videoRatio;
        }
        
        return { width, height };
      }

      resizeOverlays() {
        if (this.video.videoWidth === 0 || this.video.videoHeight === 0) return;
        
        const dimensions = this.videoDimensions();
        const frameWidth = dimensions.width;
        const left = (this.video.offsetWidth - frameWidth) / 2;
        const bottom = (this.video.offsetHeight - dimensions.height) / 2;
        
        this.metadata.style.width = frameWidth + 'px';
        this.metadata.style.left = left + 'px';
        
        this.controls.style.width = frameWidth + 'px';
        this.controls.style.left = left + 'px';
        this.controls.style.bottom = bottom + 'px';
      }

      setVolumeIcon(volume) {
        if (volume < 0.5) {
          this.unmuted.className = 'fas fa-volume-down';
        } else {
          this.unmuted.className = 'fas fa-volume-up';
        }
      }

      // Overlay management
      showLoading(show = true) {
        if (show) {
          this.loadingOverlay.classList.remove('hidden');
        } else {
          this.loadingOverlay.classList.add('hidden');
        }
      }

      showError(message = 'Failed to load the stream') {
        document.getElementById('errorMessage').textContent = message;
        this.errorOverlay.style.display = 'flex';
        this.showLoading(false);
      }

      hideError() {
        this.errorOverlay.style.display = 'none';
      }

      updateStreamInfo(info = 'Stream Active') {
        document.getElementById('qualityInfo').textContent = info;
      }

      // Timer management
      setHideOverlaysTimer() {
        this.hideOverlaysTimer = setTimeout(() => {
          if (this.video.paused) return;
          document.body.classList.add('hideOverlays');
        }, 3000);
      }

      clearHideOverlaysTimer() {
        if (this.hideOverlaysTimer) {
          clearTimeout(this.hideOverlaysTimer);
          this.hideOverlaysTimer = null;
        }
      }

      showOverlays() {
        document.body.classList.remove('hideOverlays');
        this.clearHideOverlaysTimer();
        if (!this.video.paused) {
          this.setHideOverlaysTimer();
        }
      }

      // HLS setup
      setupHLS() {
        if (!this.videoUrl) {
          this.showError('No video URL provided. Add ?url=YOUR_STREAM_URL to the page URL');
          return;
        }

        if (Hls.isSupported()) {
          const hlsConfig = {
            maxMaxBufferLength: 100,
            enableWorker: true,
            lowLatencyMode: true,
            backBufferLength: 90,
            maxBufferHole: 0.5,
            maxBufferSize: 60 * 1000 * 1000,
            maxBufferLength: 30,
            liveSyncDurationCount: 3
          };

          this.hls = new Hls(hlsConfig);
          this.hls.loadSource(this.videoUrl);
          this.hls.attachMedia(this.video);

          // HLS event listeners
          this.hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
            console.log('HLS manifest parsed', data);
            this.isLive = data.live || false;
            
            if (data.levels && data.levels.length > 0) {
              const level = data.levels[0];
              this.updateStreamInfo(`${level.width}x${level.height} @ ${Math.round(level.bitrate / 1000)}k`);
            }
            
            // Auto-play
            this.video.play().catch(e => {
              console.log('Autoplay prevented:', e);
              this.showLoading(false);
            });
          });

          this.hls.on(Hls.Events.LEVEL_SWITCHED, (event, data) => {
            const level = this.hls.levels[data.level];
            if (level) {
              this.updateStreamInfo(`${level.width}x${level.height} @ ${Math.round(level.bitrate / 1000)}k`);
            }
          });

          this.hls.on(Hls.Events.ERROR, (event, data) => {
            console.error('HLS Error:', data);
            
            if (data.fatal) {
              switch (data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  this.showError('Network error - Please check your internet connection and try again');
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  this.showError('Media error - The stream format is not supported or corrupted');
                  break;
                default:
                  this.showError(`Stream error: ${data.type}. Please try refreshing the page`);
                  break;
              }
            }
          });

          this.hls.on(Hls.Events.FRAG_LOADED, () => {
            this.hideError();
          });

        } else if (this.video.canPlayType('application/vnd.apple.mpegurl')) {
          // Safari fallback
          this.video.src = this.videoUrl;
          this.video.addEventListener('loadedmetadata', () => {
            this.video.play().catch(console.log);
          });
        } else {
          this.showError('HLS streaming is not supported in this browser. Please use a modern browser like Chrome, Firefox, or Safari');
        }
      }

      // Event listeners setup
      setupEventListeners() {
        // Mouse movement for overlay visibility
        document.body.addEventListener('mousemove', () => {
          this.showOverlays();
        });

        // Window resize
        window.addEventListener('resize', () => {
          this.resizeOverlays();
        });

        // Play button
        this.play.addEventListener('click', () => {
          this.video.play();
        });

        // Pause button
        this.pause.addEventListener('click', () => {
          this.video.pause();
        });

        // Video click toggle
        this.video.addEventListener('click', () => {
          if (this.video.paused) {
            this.video.play();
          } else {
            this.video.pause();
          }
        });

        // Video events
        this.video.addEventListener('loadstart', () => {
          this.showLoading(true);
          this.hideError();
        });

        this.video.addEventListener('loadeddata', () => {
          this.resizeOverlays();
          this.showLoading(false);
        });

        this.video.addEventListener('canplay', () => {
          this.showLoading(false);
        });

        this.video.addEventListener('play', () => {
          this.play.classList.add('hidden');
          this.pause.classList.remove('hidden');
          this.setHideOverlaysTimer();
        });

        this.video.addEventListener('pause', () => {
          this.pause.classList.add('hidden');
          this.play.classList.remove('hidden');
          document.body.classList.remove('hideOverlays');
          this.clearHideOverlaysTimer();
        });

        this.video.addEventListener('durationchange', () => {
          if (!this.isLive && this.video.duration && isFinite(this.video.duration)) {
            this.duration.textContent = this.toHHMMSS(this.video.duration);
            this.seek.max = this.video.duration;
          } else {
            this.duration.textContent = 'LIVE';
            this.seek.style.display = 'none';
          }
        });

        this.video.addEventListener('timeupdate', () => {
          this.elapsed.textContent = this.toHHMMSS(this.video.currentTime);
          if (!this.isLive && this.video.duration && isFinite(this.video.duration)) {
            this.seek.value = this.video.currentTime;
          }
        });

        this.video.addEventListener('error', (e) => {
          console.error('Video error:', e);
          this.showError('Video playback error occurred');
        });

        // Volume control
        this.volume.addEventListener('input', () => {
          this.video.volume = this.volume.value;
          this.setVolumeIcon(this.video.volume);
        });

        // Mute controls
        this.unmuted.addEventListener('click', () => {
          this.video.muted = true;
          this.unmuted.classList.add('hidden');
          this.muted.classList.remove('hidden');
          this.volume.disabled = true;
        });

        this.muted.addEventListener('click', () => {
          this.video.muted = false;
          this.muted.classList.add('hidden');
          this.unmuted.classList.remove('hidden');
          this.volume.disabled = false;
        });

        // Seek control
        this.seek.addEventListener('input', () => {
          if (!this.isLive) {
            this.video.currentTime = this.seek.value;
          }
        });

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

          switch(e.code) {
            case 'Space':
              e.preventDefault();
              if (this.video.paused) {
                this.video.play();
              } else {
                this.video.pause();
              }
              break;
            case 'KeyF':
              e.preventDefault();
              if (document.fullscreenElement) {
                document.exitFullscreen();
              } else {
                this.video.requestFullscreen().catch(console.log);
              }
              break;
            case 'KeyM':
              e.preventDefault();
              this.video.muted = !this.video.muted;
              if (this.video.muted) {
                this.unmuted.classList.add('hidden');
                this.muted.classList.remove('hidden');
                this.volume.disabled = true;
              } else {
                this.muted.classList.add('hidden');
                this.unmuted.classList.remove('hidden');
                this.volume.disabled = false;
              }
              break;
            case 'ArrowLeft':
              e.preventDefault();
              if (!this.isLive) {
                this.video.currentTime = Math.max(0, this.video.currentTime - 10);
              }
              break;
            case 'ArrowRight':
              e.preventDefault();
              if (!this.isLive) {
                this.video.currentTime = Math.min(this.video.duration, this.video.currentTime + 10);
              }
              break;
          }
        });
      }

      // Initialize player
      init() {
        // Get video URL from query parameter
        this.videoUrl = this.getParameterByName('url');
        
        // Set initial volume
        this.video.volume = 0.8;
        this.setVolumeIcon(this.video.volume);
        
        // Setup event listeners
        this.setupEventListeners();
        
        // Setup HLS
        this.setupHLS();
        
        // Update title if URL is provided
        if (this.videoUrl) {
          document.getElementById('title').textContent = 'Live Stream';
          document.getElementById('subtitle').textContent = 'Loading...';
        } else {
          document.getElementById('title').textContent = 'HLS Video Player';
          document.getElementById('subtitle').textContent = 'Add ?url=YOUR_STREAM_URL to play a stream';
        }
        
        // Show overlays initially
        this.showOverlays();
      }
    }

    // Retry function for error overlay
    function retryStream() {
      window.location.reload();
    }

    // Initialize player when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      new HLSVideoPlayer();
    });

    // Handle fullscreen changes
    document.addEventListener('fullscreenchange', () => {
      // Trigger resize after a short delay to ensure proper dimensions
      setTimeout(() => {
        if (window.player) {
          window.player.resizeOverlays();
        }
      }, 100);
    });
  </script>
</body>
</html>